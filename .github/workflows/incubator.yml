name: Incubator

on:
    workflow_dispatch:

env:
    SQLITE_RELEASE_YEAR: "2023"
    SQLITE_VERSION: "3420000"
    SQLEAN_VERSION: "0.21.0"

jobs:
    download-sources:
        name: Download and store sources
        runs-on: ubuntu-20.04
        steps:
            - name: Checkout sources
              uses: actions/checkout@v3

            - name: Download sqlite
              run: |
                  curl -L https://github.com/sqlite/sqlite/raw/master/src/test_windirent.h --output src/test_windirent.h
                  curl -L http://sqlite.org/$SQLITE_RELEASE_YEAR/sqlite-amalgamation-$SQLITE_VERSION.zip --output sqlite.zip
                  unzip sqlite.zip
                  mv sqlite-amalgamation-$SQLITE_VERSION/* src

            - name: Download sqlean
              run: |
                  curl -L https://github.com/nalgeon/sqlean/archive/refs/tags/$SQLEAN_VERSION.zip --output sqlean.zip
                  unzip sqlean.zip
                  mv sqlean-$SQLEAN_VERSION/src/* src
                  cat src/sqlite3.c src/initsqlite.c > src/sqlean.c
                  cat src/shell.c src/initshell.c > src/sqleanshell.c

            - name: Store sources
              uses: actions/upload-artifact@v3
              with:
                  name: sqlite-sources
                  path: src

    build-ubuntu:
        name: Build for Ubuntu
        runs-on: ubuntu-20.04
        needs: download-sources
        permissions:
            contents: write
        steps:
            - uses: actions/download-artifact@v3
              with:
                  name: sqlite-sources
                  path: src

            - name: Compile sqlite
              run: |
                  mkdir -p dist
                  gcc \
                    -DHAVE_READLINE \
                    -DSQLITE_ENABLE_DBPAGE_VTAB \
                    -DSQLITE_ENABLE_DBSTAT_VTAB \
                    -DSQLITE_ENABLE_EXPLAIN_COMMENTS \
                    -DSQLITE_ENABLE_FTS4 \
                    -DSQLITE_ENABLE_FTS5 \
                    -DSQLITE_ENABLE_GEOPOLY \
                    -DSQLITE_ENABLE_JSON1 \
                    -DSQLITE_ENABLE_MATH_FUNCTIONS \
                    -DSQLITE_ENABLE_OFFSET_SQL_FUNC \
                    -DSQLITE_ENABLE_RTREE \
                    -DSQLITE_ENABLE_STAT4 \
                    -DSQLITE_ENABLE_STMTVTAB \
                    -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION \
                    -DSQLITE_HAVE_ZLIB \
                    -DSQLITE_LIKE_DOESNT_MATCH_BLOBS \
                    -DSQLITE_THREADSAFE=0 \
                    -DUSE_URI \
                    src/shell.c src/sqlite3.c -o dist/sqlite3-ubuntu \
                    -ldl -lz -lm -lreadline -lncurses
                  chmod +x dist/sqlite3-ubuntu

            - name: Compile sqlean
              run: |
                  mkdir -p dist
                  gcc \
                    -DHAVE_READLINE \
                    -DSQLITE_ENABLE_DBPAGE_VTAB \
                    -DSQLITE_ENABLE_DBSTAT_VTAB \
                    -DSQLITE_ENABLE_EXPLAIN_COMMENTS \
                    -DSQLITE_ENABLE_FTS4 \
                    -DSQLITE_ENABLE_FTS5 \
                    -DSQLITE_ENABLE_GEOPOLY \
                    -DSQLITE_ENABLE_JSON1 \
                    -DSQLITE_ENABLE_MATH_FUNCTIONS \
                    -DSQLITE_ENABLE_OFFSET_SQL_FUNC \
                    -DSQLITE_ENABLE_RTREE \
                    -DSQLITE_ENABLE_STAT4 \
                    -DSQLITE_ENABLE_STMTVTAB \
                    -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION \
                    -DSQLITE_HAVE_ZLIB \
                    -DSQLITE_LIKE_DOESNT_MATCH_BLOBS \
                    -DSQLITE_THREADSAFE=0 \
                    -DUSE_URI \
                    -DSQLITE_EXTRA_INIT=core_init \
                    -DSQLEAN_VERSION="\"$SQLEAN_VERSION\"" \
                    -include src/regexp/constants.h \
                    src/sqleanshell.c src/sqlean.c src/sqlite3-sqlean.c \
                    src/crypto/*.c src/define/*.c src/fileio/*.c src/fuzzy/*.c \
                    src/math/*.c src/regexp/*.c src/regexp/pcre2/*.c src/stats/*.c \
                    src/text/*.c src/unicode/*.c src/uuid/*.c src/vsv/*.c \
                    -o dist/sqlean-ubuntu \
                    -ldl -lz -lm -lreadline -lncurses
                  chmod +x dist/sqlean-ubuntu

            - name: Upload binaries to release
              uses: svenstaro/upload-release-action@v2
              with:
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  file: dist/*-ubuntu
                  file_glob: true
                  overwrite: true
                  tag: incubator

    # build-windows:
    #     name: Build for Windows
    #     runs-on: windows-2019
    #     needs: download-sources
    #     permissions:
    #         contents: write
    #     steps:
    #         - uses: actions/download-artifact@v3
    #           with:
    #               name: sqlite-sources
    #               path: src

    #         - name: Compile sources
    #           shell: bash
    #           run: |
    #               mkdir -p dist
    #               gcc -I. src/shell.c src/sqlite3.c -o dist/sqlite3.exe \
    #                 -DSQLITE_ENABLE_DBPAGE_VTAB \
    #                 -DSQLITE_ENABLE_DBSTAT_VTAB \
    #                 -DSQLITE_ENABLE_EXPLAIN_COMMENTS \
    #                 -DSQLITE_ENABLE_FTS4 \
    #                 -DSQLITE_ENABLE_FTS5 \
    #                 -DSQLITE_ENABLE_GEOPOLY \
    #                 -DSQLITE_ENABLE_JSON1 \
    #                 -DSQLITE_ENABLE_MATH_FUNCTIONS \
    #                 -DSQLITE_ENABLE_OFFSET_SQL_FUNC \
    #                 -DSQLITE_ENABLE_RTREE \
    #                 -DSQLITE_ENABLE_STAT4 \
    #                 -DSQLITE_ENABLE_STMTVTAB \
    #                 -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION \
    #                 -DSQLITE_LIKE_DOESNT_MATCH_BLOBS \
    #                 -DSQLITE_THREADSAFE=0 \
    #                 -DUSE_URI

    #         - name: Upload binaries to release
    #           uses: svenstaro/upload-release-action@v2
    #           with:
    #               repo_token: ${{ secrets.GITHUB_TOKEN }}
    #               file: dist/sqlite3.exe
    #               asset_name: sqlite3.exe
    #               overwrite: true
    #               tag: incubator

    # build-macos:
    #     name: Build for macOS
    #     runs-on: macos-11
    #     needs: download-sources
    #     permissions:
    #         contents: write
    #     steps:
    #         - uses: actions/download-artifact@v3
    #           with:
    #               name: sqlite-sources
    #               path: src

    #         - name: Compile sources (x86)
    #           run: |
    #               mkdir -p dist
    #               gcc \
    #                 -DHAVE_READLINE \
    #                 -DSQLITE_ENABLE_DBPAGE_VTAB \
    #                 -DSQLITE_ENABLE_DBSTAT_VTAB \
    #                 -DSQLITE_ENABLE_EXPLAIN_COMMENTS \
    #                 -DSQLITE_ENABLE_FTS4 \
    #                 -DSQLITE_ENABLE_FTS5 \
    #                 -DSQLITE_ENABLE_GEOPOLY \
    #                 -DSQLITE_ENABLE_JSON1 \
    #                 -DSQLITE_ENABLE_MATH_FUNCTIONS \
    #                 -DSQLITE_ENABLE_OFFSET_SQL_FUNC \
    #                 -DSQLITE_ENABLE_RTREE \
    #                 -DSQLITE_ENABLE_STAT4 \
    #                 -DSQLITE_ENABLE_STMTVTAB \
    #                 -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION \
    #                 -DSQLITE_HAVE_ZLIB \
    #                 -DSQLITE_LIKE_DOESNT_MATCH_BLOBS \
    #                 -DSQLITE_THREADSAFE=0 \
    #                 -DUSE_URI \
    #                 src/shell.c src/sqlite3.c -o dist/sqlite3-macos-x86 \
    #                 -target x86_64-apple-macos10.12 \
    #                 -ldl -lz -lm -lreadline -lncurses

    #         - name: Compile sources (arm)
    #           run: |
    #               mkdir -p dist
    #               gcc \
    #                 -DHAVE_READLINE \
    #                 -DSQLITE_ENABLE_DBPAGE_VTAB \
    #                 -DSQLITE_ENABLE_DBSTAT_VTAB \
    #                 -DSQLITE_ENABLE_EXPLAIN_COMMENTS \
    #                 -DSQLITE_ENABLE_FTS4 \
    #                 -DSQLITE_ENABLE_FTS5 \
    #                 -DSQLITE_ENABLE_GEOPOLY \
    #                 -DSQLITE_ENABLE_JSON1 \
    #                 -DSQLITE_ENABLE_MATH_FUNCTIONS \
    #                 -DSQLITE_ENABLE_OFFSET_SQL_FUNC \
    #                 -DSQLITE_ENABLE_RTREE \
    #                 -DSQLITE_ENABLE_STAT4 \
    #                 -DSQLITE_ENABLE_STMTVTAB \
    #                 -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION \
    #                 -DSQLITE_HAVE_ZLIB \
    #                 -DSQLITE_LIKE_DOESNT_MATCH_BLOBS \
    #                 -DSQLITE_THREADSAFE=0 \
    #                 -DUSE_URI \
    #                 src/shell.c src/sqlite3.c -o dist/sqlite3-macos-arm \
    #                 -target arm64-apple-macos11 \
    #                 -ldl -lz -lm -lreadline -lncurses

    #         - name: Create universal binary
    #           run: |
    #               lipo -create -output dist/sqlite3-macos \
    #                 dist/sqlite3-macos-x86 dist/sqlite3-macos-arm
    #               chmod +x dist/sqlite3-macos

    #         - name: Upload binaries to release
    #           uses: svenstaro/upload-release-action@v2
    #           with:
    #               repo_token: ${{ secrets.GITHUB_TOKEN }}
    #               file: dist/sqlite3-macos
    #               asset_name: sqlite3-macos
    #               overwrite: true
    #               tag: incubator
